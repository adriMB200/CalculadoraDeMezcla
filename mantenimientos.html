<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="imagen/img.jpg" />
    <title>Gestor de Motos y Mantenimientos</title>
    <link rel="stylesheet" href="estilo.css">

    <!-- Bloquea el script RUM de Netlify para evitar errores -->
    <script>
        window.netlify = window.netlify || {};
        window.netlify.disableRUM = true;
    </script>
</head>

<body>

    <div style="text-align:center; margin: 20px 0;">
        <button onclick="window.location.href='index.html'" class="operator">üè† Volver al inicio</button>
    </div>

    <div class="info-container">
        <h2>üìò Mis Motos y Mantenimientos</h2>

        <form id="motoForm" style="margin-bottom: 20px;">

            <!-- Selector de marca -->
            <label for="marca"><strong>Marca:</strong></label>
            <select id="marca" required onchange="actualizarModelos()">
                <option value="">Selecciona una marca</option>
                <option value="KTM">KTM</option>
                <option value="GasGas">GasGas</option>
            </select>

            <!-- Selector de modelo -->
            <label for="modelo"><strong>Modelo:</strong></label>
            <select id="modelo" required>
                <option value="">Selecciona un modelo</option>
            </select>

            <!-- Selector de a√±o -->
            <label for="anio"><strong>A√±o:</strong></label>
            <select id="anio" required>
                <option value="">Selecciona un a√±o</option>
            </select>

            <button type="submit" class="operator">‚ûï A√±adir Moto</button>
        </form>

        <div id="motoList"></div>
    </div>

    <script>
        // ======= Datos predefinidos =======
        const modelosPorMarca = {
            "KTM": ["EXC 250", "EXC 300", "EXC-F 450"],
            "GasGas": ["EC 200", "EC 250", "EC 300"],
        };

        const selectAnio = document.getElementById("anio");
        const anios = [];
        for (let i = 2000; i <= 2025; i++) anios.push(i);
        anios.reverse().forEach(a => {
            const option = document.createElement("option");
            option.value = a;
            option.textContent = a;
            selectAnio.appendChild(option);
        });

        function actualizarModelos() {
            const marcaSeleccionada = document.getElementById("marca").value;
            const selectModelo = document.getElementById("modelo");
            selectModelo.innerHTML = "<option value=''>Selecciona un modelo</option>";
            if (modelosPorMarca[marcaSeleccionada]) {
                modelosPorMarca[marcaSeleccionada].forEach(modelo => {
                    const option = document.createElement("option");
                    option.value = modelo;
                    option.textContent = modelo;
                    selectModelo.appendChild(option);
                });
            }
        }

        // ======= Gesti√≥n de motos con Neon DB =======
        const motoForm = document.getElementById("motoForm");
        const motoList = document.getElementById("motoList");

        // Renderizar motos desde la DB
        async function renderMotos() {
            motoList.innerHTML = "<p>Cargando motos...</p>";

            try {
                const res = await fetch('/.netlify/functions/getMotos'); // funci√≥n que devuelve todas las motos
                if (!res.ok) throw new Error(await res.text());
                const motos = await res.json();

                if (motos.length === 0) {
                    motoList.innerHTML = "<p>No hay motos registradas.</p>";
                    return;
                }

                motoList.innerHTML = '';
                motos.forEach(moto => {
                    const div = document.createElement("div");
                    div.classList.add("moto-card");
                    div.style.border = "1px solid #ccc";
                    div.style.padding = "10px";
                    div.style.marginBottom = "10px";

                    const mantenimientosHtml = (moto.mantenimientos || []).map(m =>
                        `<li>üìÖ ${m.fecha} ‚Äî üïí ${m.horas} h ‚Äî ${m.descripcion}</li>`).join('');

                    div.innerHTML = `
                    <h3>üèçÔ∏è ${moto.marca} ${moto.modelo} (${moto.anio}) ‚Äî Mat: ${moto.matricula}</h3>
                    <button onclick="agregarMantenimiento('${moto.matricula}')" class="operator">üõ†Ô∏è A√±adir mantenimiento</button>
                    <ul>${mantenimientosHtml}</ul>
                `;
                    motoList.appendChild(div);
                });
            } catch (err) {
                motoList.innerHTML = `<p>Error cargando motos: ${err.message}</p>`;
            }
        }

        // A√±adir nueva moto
        motoForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            const marca = document.getElementById("marca").value;
            const modelo = document.getElementById("modelo").value;
            const anio = parseInt(document.getElementById("anio").value);

            const matricula = prompt("Introduce la matr√≠cula de la moto (ej: 1234ABC)");
            if (!matricula) return alert("Debes introducir una matr√≠cula");

            if (!marca || !modelo || !anio) return alert("Selecciona todos los campos");

            try {
                const res = await fetch('/.netlify/functions/addMoto', {
                    method: 'POST',
                    body: JSON.stringify({ matricula, marca, modelo, anio })
                });
                if (!res.ok) throw new Error(await res.text());
                alert("Moto registrada correctamente");
                renderMotos();
                motoForm.reset();
            } catch (err) {
                alert("Error al registrar moto: " + err.message);
            }
        });

        // A√±adir mantenimiento
        async function agregarMantenimiento(matricula) {
            const descripcion = prompt("Descripci√≥n del mantenimiento (ej: cambio aceite, revisi√≥n pastillas...)");
            if (!descripcion) return;

            const horas = prompt("Introduce las horas del motor al realizar este mantenimiento (ej: 80)");
            if (horas === null || horas.trim() === "" || isNaN(horas)) {
                return alert("Debes introducir un n√∫mero v√°lido de horas");
            }

            try {
                const res = await fetch('/.netlify/functions/addMantenimiento', {
                    method: 'POST',
                    body: JSON.stringify({ matricula, descripcion, horas: parseInt(horas) })
                });
                if (!res.ok) throw new Error(await res.text());
                alert("Mantenimiento registrado correctamente");
                renderMotos();
            } catch (err) {
                alert("Error al registrar mantenimiento: " + err.message);
            }
        }

        // Inicializa todo al cargar
        renderMotos();
    </script>


</body>

</html>